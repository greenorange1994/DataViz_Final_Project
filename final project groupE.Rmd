---
title: "Do Expensive Restaurants Really Provide More Satisfying Food?"
author: "Yelp Team (Group E)"
date: "April 30, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(mc.cores = 1)
```


```{r include = FALSE}
library(dplyr)
library(plyr)
library(rgdal)
library(ggplot2)
library(ggmap)
library(tmap)
library(readr)
library(tidyr)
library(sp)
library(geosphere)
library(rgeos)
library(readxl)
library(ggthemes)
library(plotly)
library(RColorBrewer)
library(leaflet)
library(stringr)
library(maps)
```  


# Overview and Motivation

Our project aims to identify the relationship between restaurant's rating, its price, as well as their correlation with other related factors, such as parking options, noise level, convenience and safety level of the location using Yelp data. The motivation of this project is really simple: we have been curious for a while about whether more expensive restaurants indeed provide better, more satisfying food. When people eat out at expensive restaurants, they tend to give out decent ratings on Yelp, which will be tested later in this project. But is it all about the food there? Or there are other factors that influence people's ratings? By conducting descriptive, locational, and text analysis, we proved our hypothesis that more expensive restaurants do not necessarily provide more satisfying food, and discovered that their high ratings are more related to their services (parking options), ambiance (noise levels) and locational factors (proximity to subway stations).  


# Related Work

We were not inspired by any related works for this project. It is possible that other people have done similar works on this topic, yet all graphs and analysis here were not inspired or related to any previous works.   



# Questions 
  
The major question is our title: Do expensive restaurants really provide more satisfying food? In order to answer this question, we separated it into three more specific questions: Do more expensive restaurants have higher rating, better service, and nicer environment? Where are the restaurants distributed in Pittsburgh? What do customers really say about these restaurants?



# Data 

Our Yelp data is gathered from Yelp Dataset Challenge (https://www.yelp.com/dataset_challenge). Since only a limited number of US cities are available in this dataset, we chose Pittsburgh as the target city in our project. We first used Python to clean the data and tease out the information we need from the original, complicated json format files, and imported the cleaned data into R to conduct data visualization. 

Other datasets that we used to analyze the relationships between restaurant ratings, price, and other related variables, are:

Pittsburgh Lightrail/Neighborhood Map Data (http://pittsburghpa.gov/dcp/gis/gis-data-new)

Pittsburgh Crime Data (http://old.post-gazette.com/neigh_city/20030730crimedatapart1p9.asp)



# Exploratory Data Analysis 

### 1. Do more expensive restaurants have higher rating, better service, and nicer environment? A correlation and descriptive analysis.


We started by looking for the relationship between rating and price level. In Yelp, restaurants with more dollar signs are more expensive, ranging from 1 to 4, and ratings are calculated by averaging customers' ratings towards the restaurants, ranging from 1 to 5 stars. The graph below shows the relationship between restaurant's rating and price. Restaurants with a price of 3 dollar signs and below show a wide range of ratings, from 1.5 to 5, with the same median ratings at 3.5 (out of 5). However, extremely low ratings exist for restaurants with 1 or 2 dollar signs, while this is not the case for restaurants with 3 dollar signs. On the other hand, restaurants with 4 dollar signs show relatively high ratings in general. These restaurants have a median of 4 stars, suggesting that over 50% of them are rated above 4. However, while these most expensive restaurants never have ratings below 3 stars, they are never rated higher than 4.5 stars, either. Thus, we conclude that the most expensive restaurants do have slightly higher ratings than other cheaper restaurants in general and never get ratings below 3, but they rarely get the most satisfying score at 5 at the same time.  

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}
pit_rest <- read.csv("pit_restaurants.csv")[, -1]
pit_rest$price <- as.factor(pit_rest$price)
pit_rest$stars <- as.factor(pit_rest$stars)
pit_rest$cuisine <- as.factor(pit_rest$cuisine)
pit_rest$parking <- as.factor(pit_rest$parking)
pit_rest$parking <- gsub('arage', 'garage', pit_rest$parking)
```

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}
p1 <- plot_ly(pit_rest) %>%
  add_trace(y = ~stars, type = "box", color = ~price,
            name = "ratings", marker = list(symbol = "circle")) %>%
  add_annotations(text = "Price Levels", xref="paper", yref="paper",
                  x=1.005, xanchor="left", y=0.7, yanchor="bottom",    # Same y as legend below
                  legendtitle=TRUE, showarrow = FALSE) %>%
  layout(title = "<b>Ratings of Restaurants with Different Price Levels in Pittsburgh</b>", 
         yaxis = list(title = "Rating (Out of 5 Stars)"),
         xaxis= list(title = "Price Levels (1 to 4 dollar-signs)"),
         legend=list(y=0.7, yanchor="top"))
p1
```  




Besides the relationship between restaurant's price level and rating, we intended to delve into their correlations with other factors as well. We first studied the relationship between price and parking options. Based on Yelp dataset, we categorized parking options into the following types:  

1) Garage: usually attached to residential apartments/houses.
2) Validated parking: restaurants/businesses pay for their customers' parking.
3) Valet parking: clients don't have to find a parking space for the businesses/restaurants they visit. Valet parking can be either free or charged. 
4) Street: usually charged on meters. 
5) Lot: public parking space, which can be free or charged.  



```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}
p2 <- plot_ly(filter(pit_rest, parking != "")) %>%
  add_trace(y = ~price, type = "box", color = ~parking,
            name = "parking", marker = list(symbol = "circle")) %>%
  add_annotations(text = "Parking Options", xref="paper", yref="paper",
                  x=1.02, xanchor="left", y=0.6, yanchor="bottom",    # Same y as legend below
                  legendtitle=TRUE, showarrow = FALSE) %>%
  layout(title = "<b>Parking Options of Restaurants with Different Price Levels</b>", 
         yaxis = list(title = "Price Levels (1 to 4 dollar-signs)"),
         xaxis= list(title = "Parking Options"),
         legend=list(y=0.6, yanchor="top"))
p2
```  




On the above boxplot, y-axis represents the average price levels for all restaurants. Restaurants that provide validated parking method tend to be more expensive than others, with a median of 3 dollar signs and a range from 2 to 4 dollar signs. Valet parking is associated with the widest range of price levels among restaurants, from 1 to 4 dollar signs. Restaurants with garage, lot, and street parking share a price level median of 2 dollar signs and, except for some street-parking outliers, those restaurants have no more than 3 dollar signs. Restaurants with garage parking are almost uniformly at the 2-dollar sign level, with only a few outliers at 3 or 1. Our results are coherent with real world logic and make sense intuitively. Validated parking usually gives customers free parking tickets whose fees may be already included in the meal price, leading to more dollar signs of the restaurants. While valet parking provides parking services for their customers, they are not necessarily free. Therefore, the meal price varies. Garage parking usually indicates that the restaurants are home-styled, which are usually not too cheap nor too expensive. Restaurants that offer street parking and public parking lots as their parking options are more likely to be by the street and do not own any parking spaces. Thus, it makes sense that restaurants provides lots and street parking are less expensive in general. According to our research, Pittsburgh has a new meter-system on the street that allows drivers to find the closest parking space near their destination, which saves them time and money. This may explain the outlier restaurants that have 4 dollar signs but only provide street parking. 



```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}
pit_noise <- na.omit(pit_rest[, c("price", "noise")]) %>% group_by(price) %>%
  mutate(average = sum(noise == "average") / sum(!is.na(price)),
            loud = sum(noise == "loud") / sum(!is.na(price)), 
            quiet = sum(noise == "quiet")/ sum(!is.na(price)),
            very_loud = sum(noise == "very_loud")/ sum(!is.na(price)))

y <- c('1',
       '2',
       '3',
       '4')
x1 <- c(20.4, 15.1, 19.6, 25.0)
x2 <- c(47.6, 60.9, 59.8, 41.7)
x3 <- c(8.3, 8.1, 3.1, 8.3)
x4 <- c(2.2, 2.4, 3.1, 0.0)

data <- data.frame(y, x1, x2, x3, x4)

top_labels <- c('Quiet', 'Average', 'Loud', 'Very Loud')

p3 <- plot_ly(data, x = ~x1, y = ~y, name = "Quiet", type = 'bar', orientation = 'h',
        marker = list(color = 'rgba(38, 24, 74, 0.8)',
                      line = list(color = 'rgb(248, 248, 249)', width = 1))) %>%
  add_trace(x = ~x2, name = "Average", marker = list(color = 'rgba(71, 58, 131, 0.8)')) %>%
  add_trace(x = ~x3, name = "Loud", marker = list(color = 'rgba(122, 120, 168, 0.8)')) %>%
  add_trace(x = ~x4, name = "Very_loud", marker = list(color = 'rgba(164, 163, 204, 0.85)')) %>%
  layout(title = "<b>Noise Level of Restaurants with Different Price Levels</b>",
        font = list(size = 12),
        xaxis = list(title = "",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE,
                      domain = c(0.15, 1)),
         yaxis = list(title = "Price Levels (1 to 4 dollar-signs)",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE),
         barmode = 'stack',
         paper_bgcolor = 'rgb(248, 248, 255)', plot_bgcolor = 'rgb(248, 248, 255)',
         margin = list(l = 50, r = 0, t = 160, b = 80),
         showlegend = FALSE) %>%
  # labeling the y-axis
  add_annotations(xref = 'paper', yref = 'y', x = 0.14, y = y,
                  xanchor = 'right',
                  text = y,
                  font = list(family = 'Arial', size = 12,
                            color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE, align = 'right') %>%
  # labeling the percentages of each bar (x_axis)
  add_annotations(xref = 'x', yref = 'y',
                  x = x1 / 2, y = y,
                  text = paste(data[,"x1"], '%'),
                  font = list(family = 'Arial', size = 12,
                            color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(xref = 'x', yref = 'y',
                  x = x1 + x2 / 2, y = y,
                  text = paste(data[,"x2"], '%'),
                  font = list(family = 'Arial', size = 12,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(xref = 'x', yref = 'y',
                  x = x1 + x2 + x3 / 2, y = y,
                  text = paste(data[,"x3"], '%'),
                  font = list(family = 'Arial', size = 12,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(xref = 'x', yref = 'y',
                  x = x1 + x2 + x3 + x4 / 2, y = y,
                  text = paste(data[,"x4"], '%'),
                  font = list(family = 'Arial', size = 12,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(xref = 'x', yref = 'paper',
                  x = c(23 / 2, 23 + 40 / 2, 23 + 38 + 21 / 2, 23 + 35 + 25 + 1 / 2),
                  y = 1.15,
                  text = top_labels,
                  font = list(family = 'Arial', size = 15,
                              color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE)
p3

``` 

The second relevant factor that we studied is restaurant's noise level. The barplot above shows the relationship between restaurant's noise level (rated by customers) and its price. According to the graph, the most expensive restaurants have the highest percentage of being quiet (25%) and are never rated as "very loud" (0%), compared to restaurants with other price levels (1, 2, 3 dollar signs). The cheapest restaurants also have relatively lower level of noises compared to averaged priced restaurants (price level 2, 3). It makes sense that the most expensive restaurants might have the nicest and quietest environment for customers, while restaurants with price levels of 2 and 3 are the most popular ones for social gatherings, and are therefore louder.  

### 2. Where are the restaurants distributed in Pittsburgh? A mapping and location analysis.


Location of restaurant may also be related to its rating and price level. To get a general idea of how restaurants are distributed in Pittsburgh, we first plotted a map with all restaurants scattered on. 


```{r, include = FALSE, fig.align='center'}
# Importing data files
pit_neighbour <- readOGR(dsn = "map/Pittsburgh_Neighborhoods.geojson", layer = "OGRGeoJSON")
stop <- readOGR("map/paacstops1611/.", "PAAC_Stops_1611")
route <- readOGR("map/paacroutes1611/.", "PAAC_Routes_1611")

map_Pit <- get_map("Pittsburgh", zoom = 13, source = "stamen", maptype = "toner-background")
pit <- ggmap(map_Pit)
pit <- pit + geom_point(aes(x = longitude, y = latitude, color = price), data = pit_rest, size = 1.5)
pit <- pit + theme_map()
pit <- pit + ggtitle("Distribution of Restaurants with Different Stars in Pittsburgh") +
  theme(plot.title = element_text(size = 10, hjust = 0.5, lineheight = .8, face = "bold"))


## Crime Level
crime <- read_excel("map/Crime_Pittsburgh.xlsx")
crime <- plyr::rename(crime, c("Crimes per 100 persons" = "Crimes_per_100_persons", "Pittsburgh neighborhoods" = "Neighborhoods"))
pit_neighbour@data <- plyr::rename(pit_neighbour@data, c("hood" = "Neighborhoods"))
crime$Safety_Level <- "Missing"
crime$Safety_Level[0 <= crime$Crimes_per_100_persons & crime$Crimes_per_100_persons <= 3] <- "Very Safe"
crime$Safety_Level[3 < crime$Crimes_per_100_persons & crime$Crimes_per_100_persons <= 6] <- "Safe"
crime$Safety_Level[6 < crime$Crimes_per_100_persons & crime$Crimes_per_100_persons <= 9] <- "Medium"
crime$Safety_Level[9 < crime$Crimes_per_100_persons & crime$Crimes_per_100_persons <= 25] <- "Dangerous"
crime$Safety_Level[20 < crime$Crimes_per_100_persons] <- "Very Dangerous"
crime$Neighborhoods[45] <- "Glen Hazel"
crime[91, ] <- crime[45, ]
crime$Neighborhoods[91] <- "Hazelwood"
crime$Neighborhoods[37] <- "Arlington Heights"
crime$Neighborhoods[48] <- "St. Clair"
crime$Neighborhoods[46] <- "Mount Washington"
crime[92, ] <- crime[46, ]
crime$Neighborhoods[92] <- "South Shore"
crime$Neighborhoods[53] <- "Duquesne Heights"
crime$Neighborhoods[75] <- "Crafton Heights"
crime$Neighborhoods[69] <- "Brighton Heights"
crime$Neighborhoods[49] <- "Northview Heights"
crime$Neighborhoods[33] <- "Spring Hill-City View"
crime$Neighborhoods[25] <- "California-Kirkbride"
crime$Neighborhoods[15] <- "Central Northside"
crime$Neighborhoods[82] <- "Troy Hill"
crime$Neighborhoods[84] <- "Stanton Heights"

## Merge
merge <- merge(pit_neighbour, crime, by = "Neighborhoods")


lonlat <- pit_rest[, c("longitude", "latitude", "price", "stars","business_id")]
restaurant_lonlat <- pit_rest
coordinates(restaurant_lonlat) <- ~ longitude + latitude
proj4string(restaurant_lonlat) <- proj4string(pit_neighbour)
lonlat2 <- over(restaurant_lonlat, pit_neighbour)
pit_rest$Neighborhoods <- lonlat2$Neighborhoods
pit_rest$price <- as.numeric(pit_rest$price)
nei <- merge(pit_rest, crime, by = "Neighborhoods")
nei <- na.omit(nei)

# Count Number
list1 <- levels(factor(nei$price))
rep0 <-rep(0,length(list1))
count_safe <- data.frame(list1, Very_Safe = rep0, Safe = rep0, Medium = rep0, Dangerous = rep0,  Very_Dangerous = rep0)
df<-nei
len<-length(df$business_id)
for (i in 1:len){
  pri<-df$price[i]
  if(df$Safety_Level[i]=='Very Safe'){
    count_safe[pri,2]=count_safe[pri,2]+1}
  if(df$Safety_Level[i]=='Safe'){
    count_safe[pri,3]=count_safe[pri,3]+1}
  if(df$Safety_Level[i]=='Medium'){
    count_safe[pri,4]=count_safe[pri,4]+1}
  if(df$Safety_Level[i]=='Dangerous'){
    count_safe[pri,5]=count_safe[pri,5]+1}
  if(df$Safety_Level[i]=='Very Dangerous'){
    count_safe[pri,6]=count_safe[pri,6]+1}
}
count <- plyr::rename(count_safe, c("list1" = "price"))
```


```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.align='center'}

m2 <- leaflet(nei) %>% 
     addTiles('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png') %>%
     setView(-80.0079238,40.4403418, zoom = 12)
# Grab a palette
pal = colorFactor("Set1", domain = nei$price)
color_price <- pal(nei$price)

# Set color of points
content <- paste("Neighbourhood:",nei$Neighborhoods,"<br/>",
                 "Price Level:",nei$price,"<br/>",
                 "Rating:",nei$stars)               
                
m2 %>% addCircleMarkers(color=color_price, 
                       popup = content, 
                       clusterOptions = markerClusterOptions())  %>%
  addLegend("bottomright", 
          pal = colorFactor("Set1", domain = nei$price), 
          values = nei$price,
          title = "Price Levels", opacity = 0.6)
```  


The map above shows the distribution of restaurants in Pittsburgh with different pricing levels marked in different colors. Most of the restaurants are within the region of Central Business District (CBD), which is the central area in Pittsburgh. Some restaurants concentrate along the river as well. In addition, most of the restaurants are rated at a price level of 1 or 2 (dots in red or blue), while very few (statistically 12) restaurants are at a price level of 4 dollar signs (purple dots) and do not have the trend of concentration.  



Many factors may be related to restaurants' locations. The two we chose to look into in our project are distance to subway (lightrail) stations and safety level of the neighborhood. 

```{r, message=FALSE, warning=FALSE, echo = FALSE, fig.align='center'}
lightrail_stop <- stop@data[which(stop@data$Mode == "Light Rail"), ]
lightrail_stop_map <- stop[which(stop$Mode == "Light Rail"), ]
lightrail_route <- route[which(route$Mode == "Light Rail"), ]
lightrail_CBD1 <- subset(lightrail_stop, Name == "WOOD STREET STATION")
lightrail_CBD2 <- subset(lightrail_stop, Name == "FIRST AVENUE STATION")
lightrail_CBD3 <- subset(lightrail_stop, Name == "STEEL PLAZA STATION")
lightrail_CBD4 <- subset(lightrail_stop, Name == "GATEWAY STATION")
lightrail_CBD <- rbind(lightrail_CBD1, lightrail_CBD2, lightrail_CBD3, lightrail_CBD4)

# Light Rail Map
restaurant_point <- pit_rest
coordinates(restaurant_point) <- ~ longitude + latitude
proj4string(restaurant_point) <- proj4string(pit_neighbour)
lightrail_route@data <- plyr::rename(lightrail_route@data, c("Route_Name" = "Route"))
map_lightrail <- tm_shape(pit_neighbour) +
  tm_borders() +
  tm_fill("Neighborhoods", title = "Neighborhood", style="pretty") +
  tm_text("Neighborhoods", col = "brown", size=.6, shadow=TRUE, bg.color="white", bg.alpha=.8, remove.overlap=TRUE) +
  tm_shape(lightrail_route) +
  tm_lines(col=c("darkblue"), lwd=3, lty = "solid", scale = 2, alpha = 0.5) +
  tm_shape(restaurant_point) +
  tm_dots(size = 0.02, col = "blue", alpha = 0.6) +
  tm_shape(lightrail_stop_map) +
  tm_dots(size = 0.15, col = "red") +
  tm_legend(legend.show = FALSE) +
  tm_compass(position=c(0.85,0.09), type="8star", size=1, show.label=2) +
  tm_style_white() +
  tm_layout("Pittsburgh Lightrail Map with Restaurant Locations", fontface = "bold", outer.margins=0, asp=0, scale=.8)

map_lightrail

```  


The map above shows the general distribution of restaurants in neighborhoods of Pittsburgh in relation to the lightrail lines (subway). Restaurants are shown as blue dots on this map, and the three lightrail lines are shown in dark blue with red points indicating lightrail stops. From the map, we can learn about the distribution of restaurants and its relationship with the lightrail as the public transportation. In the neighborhoods of Central Business District, lightrail route is one of the main transportation method. As shown on this map, a subway route goes through the central area of this neighborhood with a concentration of restaurants. From this plot, we can see that larger portion of restaurants concentrate around subway stops, especially the Gateway Station and Wood Street Station.  


```{r, message=FALSE, warning=FALSE, echo = FALSE, fig.align='center'}

restaurant_CBD <- filter(pit_rest, neighborhood == "Downtown")
coordinates(restaurant_CBD) <- ~ longitude + latitude
proj4string(restaurant_CBD) <- proj4string(pit_neighbour)
lightrail_CBD_stop <- lightrail_CBD[, c(6, 5, 2)]
names(lightrail_CBD_stop) <- c("longitude", "latitude", "stop_names")
coordinates(lightrail_CBD_stop) <- ~ longitude + latitude
proj4string(lightrail_CBD_stop) <- proj4string(pit_neighbour)
restaurant_sub <- over(lightrail_CBD_stop, pit_neighbour)

lightrail_CBD_stop <- stop[c(6949, 6991, 6951, 7000), ]

# Subsetting
CBD <- pit_neighbour$Neighborhoods == "Central Business District"
CBD_neigh <- pit_neighbour[CBD, ]
proj4string(CBD_neigh) <- proj4string(pit_neighbour)

lightrail_CBD_stop <- spTransform(lightrail_CBD_stop, CRS("+proj=longlat +datum=WGS84"))
distance <- distm(lightrail_CBD_stop@coords, restaurant_CBD@coords, fun = distHaversine)
distance <- as.data.frame(distance)
row.names(distance) <- c("FIRST AVENUE", "STEEL PLAZA", "GATEWAY", "WOOD STREET")
minimum <- apply(distance, 2, FUN = min)
find_min <- data.frame()
for (i in 1:length(minimum)){
  find_min[i,1] = row.names(distance)[which.min(distance[,i])]
  find_min[i,2] = minimum[i]
}
names(find_min) <- c("nearest_stop", "min_distance")
find_min$price <- as.factor(restaurant_CBD@data$price)
find_min$stars <- restaurant_CBD@data$stars


# Buffer
buffer <- as.data.frame(cbind(restaurant_CBD@coords, find_min),
                           stringsAsFactors = FALSE)
buffer <- filter(buffer, buffer$nearest_stop == "WOOD STREET" & buffer$min_distance <= 250)
coordinates(buffer) <- ~ longitude + latitude
proj4string(buffer) <- proj4string(pit_neighbour)
cu1 <- lightrail_CBD_stop[4,]
cu1$Name <- "WOOD STREET STATION"
p6 <- tm_shape(pit_neighbour[CBD, ]) + 
  tm_borders(col = "black", lwd = 2) +
  tm_shape(cu1) + tm_dots(col="darkblue", size=0.5) + 
  tm_text("Name", size=0.8, just=c(0.4, -0.5))

buffer2 <- spTransform(
  cu1, 
  CRS(" +init=epsg:2262 +zone=18 +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0")) 
buffer150 <- gBuffer(spgeom = buffer2, width = 150)
buffer250 <- gBuffer(spgeom = buffer2, width = 250)
p6 <- p6 + tm_shape(buffer150) + tm_borders(col="red") +
  tm_shape(buffer250) + tm_borders(col="rosybrown") + 
  tm_shape(lightrail_route) + 
  tm_lines(col = "Route", scale=3, legend.lwd.show = FALSE) +
  tm_legend(legend.show = FALSE) +
  tm_shape(buffer) +
  tm_dots(size = 0.2, col = "brown", alpha = 0.8) +
  tm_layout("Restaurants within Buffers in Central Business District", title.size = 1.1, outer.margins=0, asp=0, scale=.8)

# Second Buffer
buffer3 <- as.data.frame(cbind(restaurant_CBD@coords, find_min),
                           stringsAsFactors = FALSE)
buffer3 <- filter(buffer3, buffer3$nearest_stop == "GATEWAY" & buffer3$min_distance <= 250)
coordinates(buffer3) <- ~ longitude + latitude
proj4string(buffer3) <- proj4string(pit_neighbour)
cu2 <- lightrail_CBD_stop[3,]
cu2$Name <- "GATEWAY STATION"
p6 <- p6 + tm_shape(cu2) + tm_dots(col="darkblue", size=0.5) + 
  tm_text("Name", size=0.8, just=c(0.4, -0.5))

buffer4 <- spTransform(
  cu2, 
  CRS(" +init=epsg:2262 +zone=18 +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0")) 
buffer150_2 <- gBuffer(spgeom = buffer4, width = 150)
buffer250_2 <- gBuffer(spgeom = buffer4, width = 250)
p6 <- p6 + tm_shape(buffer150_2) + tm_borders(col="red") +
  tm_shape(buffer250_2) + tm_borders(col="rosybrown") + 
  tm_shape(lightrail_route) + 
  tm_lines(col = "Route", scale=3, legend.lwd.show = FALSE) +
  tm_legend(legend.show = FALSE) +
  tm_shape(buffer3) +
  tm_dots(size = 0.2, col = "brown", alpha = 0.8)

# Third Buffer
buffer5 <- as.data.frame(cbind(restaurant_CBD@coords, find_min),
                           stringsAsFactors = FALSE)
buffer5 <- filter(buffer5, buffer5$nearest_stop == "STEEL PLAZA" & buffer5$min_distance <= 250)
coordinates(buffer5) <- ~ longitude + latitude
proj4string(buffer5) <- proj4string(pit_neighbour)
cu3 <- lightrail_CBD_stop[2,]
cu3$Name <- "STEEL PLAZA STATION"
p6 <- p6 + tm_shape(cu3) + tm_dots(col="darkblue", size=0.5) + 
  tm_text("Name", size=0.8, just=c(0.4, -0.5))

buffer6 <- spTransform(
  cu3, 
  CRS(" +init=epsg:2262 +zone=18 +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0")) 
buffer150_3 <- gBuffer(spgeom = buffer6, width = 150)
buffer250_3 <- gBuffer(spgeom = buffer6, width = 250)
p6 <- p6 + tm_shape(buffer150_3) + tm_borders(col="red") +
  tm_shape(buffer250_3) + tm_borders(col="rosybrown") + 
  tm_shape(lightrail_route) + 
  tm_lines(col = "Route", scale=3, legend.lwd.show = FALSE) +
  tm_legend(legend.show = FALSE) +
  tm_shape(buffer5) +
  tm_dots(size = 0.2, col = "brown", alpha = 0.8)

# Final Buffer
buffer7 <- as.data.frame(cbind(restaurant_CBD@coords, find_min),
                           stringsAsFactors = FALSE)
buffer7 <- filter(buffer7, buffer7$nearest_stop == "FIRST AVENUE" & buffer7$min_distance <= 250)
coordinates(buffer7) <- ~ longitude + latitude
proj4string(buffer7) <- proj4string(pit_neighbour)
cu4 <- lightrail_CBD_stop[1,]
cu4$Name <- "FIRST AVENUE STATION"
p6 <- p6 + tm_shape(cu4) + tm_dots(col="darkblue", size=0.5) + 
  tm_text("Name", size=0.8, just=c(0.4, -0.5))

buffer8 <- spTransform(
  cu4, 
  CRS(" +init=epsg:2262 +zone=18 +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0")) 
buffer150_4 <- gBuffer(spgeom = buffer8, width = 150)
buffer250_4 <- gBuffer(spgeom = buffer8, width = 250)
p6 <- p6 + tm_shape(buffer150_4) + tm_borders(col="red") +
  tm_shape(buffer250_4) + tm_borders(col="rosybrown") + 
  tm_shape(lightrail_route) + 
  tm_lines(col = "Route", scale=3, legend.lwd.show = FALSE) +
  tm_legend(legend.show = FALSE) +
  tm_shape(buffer7) +
  tm_dots(size = 0.2, col = "brown", alpha = 0.8)

buffer9 <- as.data.frame(cbind(restaurant_CBD@coords, find_min),
                           stringsAsFactors = FALSE)
dfbuf1 <- buffer9[-which(buffer9$nearest_stop == "WOOD STREET" & buffer9$min_distance <= 250), ]
dfbuf1 <- dfbuf1[-which(dfbuf1$nearest_stop == "GATEWAY" & dfbuf1$min_distance <= 250), ]
dfbuf1 <- dfbuf1[-which(dfbuf1$nearest_stop == "STEEL PLAZA" & dfbuf1$min_distance <= 250), ]
dfbuf1 <- dfbuf1[-which(dfbuf1$nearest_stop == "FIRST AVENUE" & dfbuf1$min_distance <= 250), ]

coordinates(dfbuf1) <- ~ longitude + latitude
proj4string(dfbuf1) <- proj4string(pit_neighbour)

p6 <- p6 + tm_shape(dfbuf1) +
  tm_dots(size = 0.2, col = "darkseagreen4", alpha = 0.8) +
  tm_credits("red point: restaurants inside buffers", col = "brown") +
  tm_credits("green point: restaurants outside buffers", col = "darkseagreen4")
p6

```



To find out whether restaurants prefer locations closer to public transportation, we zoomed into the CBD area of Pittsburgh, as there are many restaurants and four lightrail stations within this area. In the plot above, we set the radius of outer buffer to be 250 meters, and the radius of inner buffer to be 150 meters. In addition, the red points indicate restaurants inside the buffers and the green points indicate restaurants outside of buffers. Comparing the number of restaurants located inside buffers, we can see that the largest number of restaurants are within the vicinity of Wood Street Station and Gateway Station. However, First Avenue Station attracts fewer restaurants, which may be due to its remote location in Central Business District compared to other stations. From the information, we can conclude that restaurants are more willing to choose a location around public transportation. 


```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}

p4 <- plot_ly(find_min) %>%
  add_trace(y = ~min_distance, type = "box", color = ~price,
            name = "price-level", marker = list(symbol = "circle")) %>%
  add_annotations(text = "Price Levels", xref="paper", yref="paper",
                  x=1.015, xanchor="left", y=0.7, yanchor="bottom",    # Same y as legend below
                  legendtitle=TRUE, showarrow = FALSE) %>%
  layout(title = "<b>Minimun Distance to Subway Stations of Restaurants </br> with Different Price Levels in CBD</b>", 
         font = list(size = 11),
         yaxis = list(title = "Minimun Distance to Subway Stations (meters)"),
         xaxis= list(title = "Price Levels (1 to 4 dollar-signs)"),
         legend=list(y=0.7, yanchor="top"))
p4
```  

To find out the relationship between restaurant's price level and its minimum distance to subway stations in Pittsburgh, we plotted the above boxplot. The most expensive restaurants tend to be closest to subway stations, with a median distance of 179 meters, and the furthest distance (255 meters) was much closer than that of all other cheaper restaurants. However, the most expensive restaurants tend to be within the range of 111m and 255m from subway stations, which is much narrower than the range of distances of other restaurants. This is possibly due partly to the small number of 4-dollar sign priced restaurants in the city. Moreover, the closer the restaurants to the subway stations, the more expensive the restaurants are. The median distances for restaurants with a price level of 3, 2, and 1 are 199m, 212m, and 228m, respectively. The cheapest restaurants also have the widest range of distances from the subway stations (from 37m to 544m).  

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}

m = leaflet(merge) %>% 
  addProviderTiles("Stamen.TonerLite") %>%
  addPolygons(group="Homicide",
                stroke = TRUE, color = "black", weight = 1, fillOpacity = 0.5, smoothFactor = 0.5, 
                fillColor = ~colorNumeric(palette = "Reds", Homicide)(Homicide),
              popup = paste("Neighborhood:", merge@data$Neighborhoods,"<br/>",
                  "Homicide:", merge@data$Homicide, "<br/>",
                  "Robbery:", merge@data$Robbery, "<br/>",
                  "Burglary:", merge@data$Burglary, "<br/>", 
                  "Theft:", merge@data$Theft, "<br/>",
                  "Crimes per 100 persons:", merge@data$Crimes_per_100_persons)) %>%
  addPolygons(group="Robbery",
                stroke = TRUE, color = "black", weight = 1, fillOpacity = 0.5, smoothFactor = 0.5, 
                fillColor = ~colorNumeric(palette = "Reds", Robbery)(Robbery),
              popup = paste("Neighborhood:", merge@data$Neighborhoods,"<br/>",
                  "Homicide:", merge@data$Homicide, "<br/>",
                  "Robbery:", merge@data$Robbery, "<br/>",
                  "Burglary:", merge@data$Burglary, "<br/>", 
                  "Theft:", merge@data$Theft, "<br/>",
                  "Crimes per 100 persons:", merge@data$Crimes_per_100_persons)) %>%
addPolygons(group="Burglary",
                stroke = TRUE, color = "black", weight = 1, fillOpacity = 0.5, smoothFactor = 0.5, 
                fillColor = ~colorNumeric(palette = "Reds", Burglary)(Burglary),
              popup = paste("Neighborhood:", merge@data$Neighborhoods,"<br/>",
                  "Homicide:", merge@data$Homicide, "<br/>",
                  "Robbery:", merge@data$Robbery, "<br/>",
                  "Burglary:", merge@data$Burglary, "<br/>", 
                  "Theft:", merge@data$Theft, "<br/>",
                  "Crimes per 100 persons:", merge@data$Crimes_per_100_persons)) %>%
  addPolygons(group="Theft",
                stroke = TRUE, color = "black", weight = 1, fillOpacity = 0.5, smoothFactor = 0.5, 
                fillColor = ~colorNumeric(palette = "Reds", Theft)(Theft),
              popup = paste("Neighborhood:", merge@data$Neighborhoods,"<br/>",
                  "Homicide:", merge@data$Homicide, "<br/>",
                  "Robbery:", merge@data$Robbery, "<br/>",
                  "Burglary:", merge@data$Burglary, "<br/>", 
                  "Theft:", merge@data$Theft, "<br/>",
                  "Crimes per 100 persons:", merge@data$Crimes_per_100_persons)) %>%
addPolygons(group = "Crimes per 100 persons",
              stroke = TRUE, color = "black",  weight = 1, fillOpacity = 0.5, smoothFactor = 0.5, 
              fillColor = ~colorNumeric(palette = "Reds", Crimes_per_100_persons)(Crimes_per_100_persons),
              popup = paste("Neighborhood:", merge@data$Neighborhoods,"<br/>",
                  "Homicide:", merge@data$Homicide, "<br/>",
                  "Robbery:", merge@data$Robbery, "<br/>",
                  "Burglary:", merge@data$Burglary, "<br/>", 
                  "Theft:", merge@data$Theft, "<br/>",
                  "Crimes per 100 persons:", merge@data$Crimes_per_100_persons)) %>% 
  addLegend("bottomright", 
    pal = colorNumeric(palette = "Reds", merge@data$Crimes_per_100_persons), 
    values = ~Crimes_per_100_persons,
    title = "Number of Crimes<br/>in Neighborhoods", opacity = 0.7) %>%
  addLayersControl(overlayGroups = c("Homicide","Robbery", "Burglary", "Theft", "Crimes per 100 persons"),
    options = layersControlOptions(collapsed = FALSE) ) %>%
  addCircleMarkers(data=restaurant_point, weight=0, radius=1.6, fillOpacity=0.6,
                   popup=~paste("Price:", price,"<br>",
                                "Stars:", stars))
m
```  


The above interactive maps shows the safety level of the different neighborhoods according to their number of crimes in homicide, robbery, burglary, theft, and the number of crimes per 100 persons. Moreover, darker red indicating larger number of crimes. Thus, we can know that neighborhoods with the higher robbery, burglary, and theft rates such as Central Business District and Strip District attract more restaurants. We postulate that most restaurants are concentrated in more crowded and richer areas to earn profit, which creates condition for the happening of theft and robbery in these areas.  

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center'}
count_safe <- readRDS("count_safe")
y <- c('1',
       '2',
       '3',
       '4')
x1 <- c(28.69, 26.19, 19.44, 27.27)
x2 <- c(20.62, 25.70, 18.06, 18.18)
x3 <- c(50.69, 48.11, 62.50, 54.55)
data <- data.frame(y, x1, x2, x3)
top_labels <- c('Safe', 'Medium', 'Dangerous')
p5 <- plot_ly(data, x = ~x1, y = ~y, name = "Safe", type = 'bar', orientation = 'h',
        marker = list(color = 'rgba(38, 24, 74, 0.8)',
                      line = list(color = 'rgb(248, 248, 249)', width = 1))) %>%
  add_trace(x = ~x2, name = "Medium", marker = list(color = 'rgba(71, 58, 131, 0.8)')) %>%
  add_trace(x = ~x3, name = "Dangerous", marker = list(color = 'rgba(122, 120, 168, 0.8)')) %>%
  layout(title = "<b>Safety Level of Locations of Restaurants with Different Price Levels</b>",
        font = list(size = 12),
        xaxis = list(title = "",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE,
                      domain = c(0.15, 1)),
         yaxis = list(title = "Price Levels (1 to 4 dollar-signs)",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE),
         barmode = 'stack',
         paper_bgcolor = 'rgb(248, 248, 255)', plot_bgcolor = 'rgb(248, 248, 255)',
         margin = list(l = 50, r = 0, t = 160, b = 80),
         showlegend = FALSE) %>% 
  add_annotations(xref = 'paper', yref = 'y', x = 0.14, y = y,
                  xanchor = 'right',
                  text = y,
                  font = list(family = 'Arial', size = 12,
                            color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE, align = 'right') %>%
  # labeling the percentages of each bar (x_axis)
  add_annotations(xref = 'x', yref = 'y',
                  x = x1 / 2, y = y,
                  text = paste(data[,"x1"], '%'),
                  font = list(family = 'Arial', size = 12,color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(xref = 'x', yref = 'y',
                  x = x1 + x2 / 2, y = y,
                  text = paste(data[,"x2"], '%'),
                  font = list(family = 'Arial', size = 12,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(xref = 'x', yref = 'y',
                  x = x1 + x2 + x3 / 2, y = y,
                  text = paste(data[,"x3"], '%'),
                  font = list(family = 'Arial', size = 12,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(xref = 'x', yref = 'paper',
                  x = c(23 / 2, 23 + 28 / 2, 23 + 38 + 21 / 2),
                  y = 1.15,
                  text = top_labels,
                  font = list(family = 'Arial', size = 15,
                              color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE)
p5
```  

The safety of the neighborhood, however, is not necessarily associated with the price levels of the restaurants. According to the plot above, restaurants with 3-dollar sign price level have more dangerous neighborhoods compared to other price levels, with only 19.44% of restaurants being in the safest areas, and while as many as 62.5% are in dangerous areas. The cheapest restaurants have a higher percent of restaurants located in the safest areas than their most expensive counterparts (28.69% vs. 27.27%), while also having a lower percent in most dangerous areas (50.69% vs 54.55%). Safety of the neighborhood does not seem to be a factor that correlates with restaurant price.  

### 3. What do customers really say about these restaurants? A text analysis.


We have learnt from previous plots that most expensive restaurants have higher ratings than other cheaper restaurants in general. But what do customers really say about these restaurants? Do most expensive restaurants have more positive reviews as well? To answer these questions, we conducted a text analysis of restaurant reviews. Below is a commonality wordcloud of all reviews of restaurants in Pittsburgh. 


```{r include = FALSE, fig.align='center'}
library(tm)
library(quanteda)
library(qdap) 
library(qdapDictionaries)
library(tidytext)
library(wordcloud)
library(tidyverse)
library(base)

pit_review <- read.csv("pit_review.csv")
review_id <- pit_review[, c(2, 8)]
review_id$count <- 1

review_1990 <- ddply(review_id, .(business_id), summarise, review = paste0(text, collapse = " "), reviewnum = sum(count))

review_1990$ratings <- pit_rest$stars

review_1990$price <- pit_rest$price

review_na <- na.omit(review_1990)

reviews <- VCorpus(DirSource("texts/"))

removeNumPunct <- function(x){gsub("[^[:alpha:][:space:]]*", "", x)}
clean_corpus <- function(corpus){
  corpus <- tm_map(corpus, removePunctuation)
  corpus <- tm_map(corpus,content_transformer(tolower))
  corpus <- tm_map(corpus, content_transformer(replace_symbol))
  corpus <- tm_map(corpus, removeWords, c(stopwords("english")))
  corpus <- tm_map(corpus, stripWhitespace)
  corpus <- tm_map(corpus, removeNumbers)
  corpus <- tm_map(corpus, content_transformer(removeNumPunct))
  return(corpus)
}

review <- clean_corpus(reviews)
review_tdm <- TermDocumentMatrix(review)
review_td <- tidy(review_tdm)

review_td$price <- substr(review_td$document, nchar(review_td$document) - 4, nchar(review_td$document) - 4)

new <- review_td[, -2]
new2 <- aggregate(new['count'], by = new[c('term', 'price')], sum)
price_matrix <- spread(new2, price, count)
price_matrix[is.na(price_matrix)] <- 0
rownames(price_matrix) <- price_matrix[,1]
price_matrix2 <- price_matrix[,-1]

purple_orange <- brewer.pal(10, "PuOr")
purple_orange <- purple_orange[-(1:2)]
```

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}
set.seed(500)
commonality.cloud(as.matrix(price_matrix2), colors =  purple_orange, max.words = 100)
```  

Among all, "food" is the most prominent frequent word that customers mention in the comments. We can say that food is the main focus of customers' reviews, and the taste or quality of the food should be the primary factor in the ratings, instead of other periphery factors such as service, environment, locations, etc. "Good," "great," "place," "time," "service" are other frequently used words in reviews.

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}

set.seed(500)
price_comp <- as.matrix(price_matrix2)
colnames(price_comp) <- c("$", "$$", "$$$", "$$$$")

comparison.cloud(price_comp, max.words = 100, scale=c(0.1,2), title.size = 1)
```  

To get a clearer sense of how people review restaurants with different price levels differently, we then drew a comparison wordcloud. Different types of food can be indicated in the comparison word-cloud according to their price levels. For example, cheap fast food like "pizza" and "sandwich" are more frequently mentioned in 1-dollar-sign restaurants compared to other price-level restaurants. "Thai," "chicken," "rice" are more frequently mentioned in reviews of 2-dollar-sign restaurants. "Reservation," "dessert," "night," "bar," "wine," "steak" begin to appear more frequently in reviews of 3-dollar-sign restaurants, showing that this level of restaurants are more likely to provide full course dishes, require reservations, and might have a bar on the side. Reviews of the most expensive restaurant contain "avocado," "sushi," "goat," "cheese," "omelet,"  "smoked," "bacon," "french," "toast," "whiskey," indicating certain specialties such as Japanese food, brunch and bars. "Waited" also appeared in the comparatively frequent words of reviews of 4-dollar-sign restaurants, suggesting that people care about and mentions the waiting time more frequently than eating in cheaper restaurants. By looking into some of the reviews of 4-dollar-sign restaurants, we postulate that most expensive restaurants have longer waiting time.  

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}
review_corpus <- corpus(reviews)
FRE_review <- textstat_readability(review_corpus, measure = c('Flesch.Kincaid'))


FKscore <- as.data.frame(FRE_review)
FKscore$price <- review_na$price
FKscore$price <- as.character(FKscore$price)

box <- plot_ly(FKscore[FKscore$FRE_review <= 10, ]) %>%
  add_trace(x = ~price, y = ~FRE_review, type = "box", color = ~price,
            name = "parking", marker = list(symbol = "circle")) %>%
  add_annotations(text = "Price Levels", xref="paper", yref="paper",
                  x=1.015, xanchor="left", y=0.6, yanchor="bottom",    # Same y as legend below
                  legendtitle=TRUE, showarrow = FALSE) %>%
  layout(title = "<b> Review FRE scores of Restaurants </br> with Different Price Levels </b>", 
         xaxis = list(title = "Price Levels (1 to 4 dollar-signs)"),
         yaxis= list(title = "FRE Scores"),
         legend=list(y=0.6, yanchor="top"))
box
```


We are also interested in the word choice of reviews of different types of restaurants. FRE scores indicate the readability of the texts in the comments, in which lower FRE scores means higher linguistic complexity. Reviews of the most expensive restaurants have the lowest FRE score median (6.04), whereas restaurants with other price-levels have higher and similar FRE score medians: the medians are 6.20, 6.25, and 6.33 for restaurants with 1-dollar-sign, 2-dollar-sign, 3-dollar-sign, respectively. Disregarding outliers, restaurants with 1-dollar-sign, 2-dollar-sign and 3-dollar-sign have similar FRE ranges as well (3.36, 3.44, 3.70), whereas the FRE range of 4-dollar-sign restaurants is only 2.52. This tells us that customers eating in the most expensive restaurants are generally more educated or tend to comment with more sophisticated and complex words than customers eating in cheaper restaurants.  



```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.align='center'}
pos <- read.table(
  "C:/Users/green/Google Drive/courses/Data Visualization/Homework/3/dictionaries/positive-words.txt", 
  as.is = TRUE)
neg <- read.table(
  "C:/Users/green/Google Drive/courses/Data Visualization/Homework/3/dictionaries/negative-words.txt", 
  as.is = TRUE)

sentiment <- function(words){ 
  n = length(words)
  out = rep(NA_real_, n)
  for (i in 1:n){
    tok <- quanteda::tokenize(words[i]) 
    pos.count <- sum(tok[[1]]%in%pos[,1]) 
    neg.count <- sum(tok[[1]]%in%neg[,1]) 
    out[i] <- (pos.count - neg.count)/(pos.count+neg.count) 
  }
  return(out)
}

review_na$sentiment <- sentiment(review_na$review)
review_na$price <- as.character(review_na$price)
review_na$ratings <- as.numeric(as.character(review_na$ratings))

sentiment <- review_na

review_na$wordcount <- sapply(gregexpr("\\S+", review_na$review), length)
review_na$ave_wc <- review_na$wordcount / review_na$reviewnum
review_na$price <- as.character(review_na$price)
review_na$ratings <- as.character(review_na$ratings)

sentiment$positive <- ifelse(sentiment$sentiment > 0.4, 1, 0)
sentiment$negative <- ifelse(sentiment$sentiment < 0, 1, 0)
sentiment$neutral <- ifelse(sentiment$sentiment < 0.4 & sentiment$sentiment > 0 , 1, 0)

sentiment_count <- sentiment %>% group_by(price) %>% summarise(pos = sum(positive), neu = sum(neutral), neg = sum(negative), sum = sum(positive) + sum(neutral) + sum(negative))
sentiment_count$posper <- sentiment_count$pos/sentiment_count$sum
sentiment_count$neuper <- sentiment_count$neu/sentiment_count$sum
sentiment_count$negper <- sentiment_count$neg/sentiment_count$sum

x <- c('1','2','3','4')
y1 <- 100 * round(sentiment_count$posper, 4)
y2 <- 100 * round(sentiment_count$neuper, 4)
y3 <- 100 * round(sentiment_count$negper, 4)

data_text <- data.frame(y1, y2, y3, x)

top_labels <- c('Positive', 'Neutral', 'Negative')

text_1 <- plot_ly(data_text, x = ~x, y = ~y1, name = "Positive", type = 'bar', orientation = 'v',
        marker = list(color = 'rgba(38, 24, 74, 0.8)',
                      line = list(color = 'rgb(248, 248, 249)', width = 1))) %>%
  add_trace(y = ~y2, name = "Neutral", marker = list(color = 'rgba(71, 58, 131, 0.8)')) %>%
  add_trace(y = ~y3, name = "Negative", marker = list(color = 'rgba(122, 120, 168, 0.8)')) %>%
  layout(title = "<b>Percentage of Restaurants </br> with Positive, Neutral or Negative Reviews</b>",
        font = list(size = 12),
        yaxis = list(title = "",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE,
                      domain = c(0.15, 1)),
         xaxis = list(title = "Price Levels (1 to 4 dollar-signs)",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE),
         barmode = 'stack',
         paper_bgcolor = 'rgb(248, 248, 255)', plot_bgcolor = 'rgb(248, 248, 255)',
         margin = list(l = 40, r = 0, t = 160, b = 80),
         showlegend = FALSE) %>%
  # labeling the x-axis
  add_annotations(yref = 'paper', xref = 'x', y = 0.09, x = x,
                  yanchor = 'right',
                  text = x,
                  font = list(family = 'Arial', size = 12,
                            color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE, align = 'right') %>%
  # labeling the percentages of each bar (x_axis)
  add_annotations(yref = 'y', xref = 'x',
                  y = y1 + y2  + y3 / 2, x = x,
                  text = paste(data_text[, "y3"], '%'),
                  font = list(family = 'Arial', size = 10,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(yref = 'y', xref = 'x',
                  y = y1 + y2 / 2, x = x,
                  text = paste(data_text[, "y2"], '%'),
                  font = list(family = 'Arial', size = 10,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(yref = 'y', xref = 'x',
                  y = y1 /2, x = x,
                  text = paste(data_text[, "y1"], '%'),
                  font = list(family = 'Arial', size = 10,
                              color = 'rgb(248, 248, 255)'),
                  showarrow = FALSE) %>%
  add_annotations(yref = 'y', xref = 'paper',
                  y = c(64 / 2, 64 + 34 / 2, 64 + 34 + 2 / 2),
                  x = -0.065,
                  text = top_labels,
                  font = list(family = 'Arial', size = 12,
                              color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE)
text_1
```


Other important thing to learn about the reviews is their tones. To measure the sentiment of restaurant reviews, we first combined all reviews of a restaurant into one text, and calculated the sentiment score of each restaurant using Hu & Liu Dictionary. Restaurants with sentiment scores higher than 0.4, between 0 and 0.4, and lower than 0 are categorized as positively reviewed, neutrally reviewed, and negative reviewed, respectively. Based on our metrics, we found that the most expensive restaurants have the lowest percentage of positively reviewed restaurants (50%) among all four price levels, yet have the lowest negatively reviewed percentage (0%) at the same time. Restaurants with 2-dollar-sign have the highest percentage of positive reviews (68.16%) and lowest percentage of neutral reviews (29.27%). Restaurants with 1 and 3 dollar signs have similar percentage of positive reviews (64.54% for 1-dollar-sign and 62.11% for 3-dollar-sign) and neutral reviews (32.52% for 1-dollar-sign and 35.29% for 3-dollar-sign). Besides the most expensive restaurants, restaurants with 1, 2, 3 dollar signs have similar small percentages of negative reviews (2.94%, 2.56%, and 2.11%, respectively). The graph suggests that most expensive restaurants, compared to other cheaper restaurants, are less likely to get positive reviews, but they never receive negative reviews, either. Since our wordclouds have shown that restaurant reviews are mainly focused on food, we can indicate that the most expensive restaurants are less likely to generate high satisfaction for food among customers, which is consistent with our hypothesis that expensive restaurants do not necessarily provide more satisfying food. 



```{r, warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}
review_na <- review_na %>% 
  arrange(desc(ratings)) %>%
  mutate(rank_ratings = row_number()) %>%
  arrange(desc(sentiment)) %>%
  mutate(rank_senti = row_number()) %>%
  mutate(diff = abs(rank_senti - rank_ratings))
MSE <- review_na[, c("price", "diff")] %>%
  group_by(price) %>%
  summarise(mse = round(sd(diff), 1))

ave_rank <- review_na[, c("price", "rank_ratings", "rank_senti")] %>%
  group_by(price) %>%
  summarise(ave_ratings = mean(rank_ratings), ave_senti = mean(rank_senti))
rank_df <- data.frame(matrix(NA, nrow = 8, ncol = 3))
names(rank_df) <- c("price", "rank_ave", "rank_class")
for (i in 1:4) {
  rank_df[i, 1] = ave_rank[i, 1] 
  rank_df[i+4, 1] = ave_rank[i, 1]
  rank_df[i, 2] = ave_rank[i, 2]
  rank_df[i+4, 2] = -ave_rank[i, 3]
  rank_df[i, 3] = "Average Ratings"
  rank_df[i+4, 3] = "Average Sentiment"
}
p7 <- ggplot(rank_df, aes(x = price, y = rank_ave, fill = rank_class)) +
  geom_bar(subset = .(rank_class == "ave_ratings"), stat = "identity", width = 0.4) +  
  geom_bar(subset = .(rank_class == "ave_senti"), stat = "identity", width = 0.4) + 
  scale_fill_brewer(palette = "Set1", direction=-1) + coord_flip() + 
  scale_y_continuous(breaks = seq(-1000, 1000, 200)) +  ylab("Average Ranking") + 
  theme_tufte() + guides(fill = guide_legend("")) + xlab("Price Levels") + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
        legend.position = c("bottom"), legend.direction = "horizontal",
        plot.title=element_text(hjust = +0.5)) + 
  ggtitle("Comparison of Average Rating Ranks and Sentiment Ranks") + 
  theme(plot.title = element_text(face = "bold", color = "black", size = 13, hjust = 0.5))
p7
```  


Finally, we compare the average rankings in ratings and sentiment scores for different price-level restaurants to get a clear picture of how unsatisfied consumers are about luxurious restaurants' food. First of all, luxurious restaurants (4 dollar signs) have the smallest average rankings in ratings. Since we sorted ratings in a descending order, smallest average rank means luxurious restaurants have best ratings. However, when we saw red bars, we can find luxurious restaurants have largest average ranking in sentiment scores. That is to say, consumer reviews about luxurious restaurants are least positive among all kinds of restaurants. Combined with previous fact that reviews are more about food, we can conclude that, although luxurious restaurants have highest ratings, they do not provide food satisfying enough based on customers' tones in reviews. Therefore, we suggest that consumers give luxurious restaurants high ratings more for their better services and environments, instead of food.  
  
  
### 3. Where should I go for food then? A shiny app. 

Using our dataset and findings above, we created a shiny app to help consumers find which restaurant in Pittsburgh can provide relatively more satisfying food based on their criteria (price level, noise level, parking option, and cuisine). Below is the link to our shiny app.

https://greenorange1994.shinyapps.io/Shiny/

To calculate recommendation levels, we ranked all restaurants in Pittsburgh based on their sentiment and rating, respectively. Then, we subtracted each restaurant's sentiment ranking by its rating ranking to get a difference score. Since ratings are ordered descendingly, the larger the difference score, the more positive its review's tone relative to its rating. We ranked the difference scores of all restaurants, and categorized them 4 levels according to quantiles: top 25% highest difference score is "more than expected", 25% to 50% is "recommended", 50% to 75% is "not bad", and the last quantile is "disappointed."




# Design Evolution

For the descriptive analysis part, originally, we planned to study whether types of cuisine have an influence on restaurants' ratings or prices. The categorization of cuisine was very hard, as Yelp has separated the restaurants in a very detailed way. Moreover, most restaurants have more than one type of food. After we categorized all restaurants into five large groups manually, we found the result not very meaningful or constructive. So we discarded the plot below. 


```{r, warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}
# Cuisines and Ratings

p5 <- plot_ly(pit_rest) %>%
  add_trace(y = ~stars, type = "box", color = ~cuisine,
            name = "price-level", marker = list(symbol = "circle")) %>%
  add_annotations(text = "cusine", xref="paper", yref="paper",
                  x=1.12, xanchor="left", y=0.7, yanchor="bottom",    # Same y as legend below
                  legendtitle=TRUE, arrowcolor = "white") %>%
  layout(title = "<b>Ratings of Different Cuisines in Pittsburgh</b>", 
         yaxis = list(title = "Rating (0 to 5 Stars)"),
         xaxis= list(title = ""),
         legend=list(y=0.7, yanchor="top"))

p5

```



We also tried to see whether the number of reviews is related to ratings of different cuisines. Again, the result was not very meaningful or constructive. 

```{r,  warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}
# Ratings and Review Counts (Cuisines)

p4 <- ggplot(pit_rest, aes(x = stars, y = review_count, color = as.factor(price))) + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, size = 0.5, color = "black") +
  facet_wrap (~ cuisine) +
  xlab("Rating Stars") +
  ylab("Review Counts") +
  theme(legend.position="bottom", legend.key.size = unit(0.4, "cm")) +
  ggtitle("Rating Stars and Review Counts for Different Types of Cuisine") +
  theme(plot.title = element_text(hjust = 0.5, lineheight = .8, face = "bold"))
p4
```


For the map analysis part, we did not start with interactive maps at first. We first plotted  restaurant locations in CBD area, using price as both consecutive and categorical variables. The map was not very clear in either way. Also, there are a large number of restaurants outside of CBD. To have a clearer and more holistic view of restaurant locations in Pittsburgh, we ended up drawing interactive maps, as presented in the above section. 


```{r,  warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}
# CBD price (consecutive)

map_Pit <- get_map("Pittsburgh", zoom = 13, source = "stamen", maptype = "toner-background")
pit <- ggmap(map_Pit)
pit <- pit + geom_point(aes(x = longitude, y = latitude, color = price), data = pit_rest, size = 1.5)
pit <- pit + theme_map()
pit <- pit + ggtitle("Distribution of Restaurants with Different Stars in Pittsburgh") +
  theme(plot.title = element_text(size = 10, hjust = 0.5, lineheight = .8, face = "bold"))
pit


# CBD price (categorical)

map_Pit <- get_map("Pittsburgh", zoom = 15, source = "stamen", maptype = "toner-background")
pit2 <- ggmap(map_Pit)
pit2 <- pit2 + geom_point(aes(x = longitude, y = latitude, color = as.factor(price)), data = pit_rest, size = 1) +
  guides(color=guide_legend(title="Price Level"))
pit2 <- pit2 + theme_map()
pit2 <- pit2 + ggtitle("Location of Restaurants in Central Business District in Pittsburgh") +
  theme(plot.title = element_text(size = 10, hjust = 0.5, lineheight = .8, face = "bold"))
pit2

```


Similarly, for the map of safety level of neighborhoods, we discarded the static map and drew an interactive one with different types of crime as layers.


```{r, warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}

# Safety on Pittsburgh

map_neighborhood <- tm_shape(merge) +
  tm_borders() +
  tm_fill("Safety_Level", title = "Safety Level", convert2density=TRUE) +
  tm_shape(restaurant_point) +
  tm_dots(size = 0.1, col = "price", alpha = 0.6) +
  tm_compass(position=c(0.85,0.09), type="8star", size=1, show.label=2) +
  tm_style_white() +
  tm_layout("Safety of Pittsburgh", title.size = 1.5, legend.title.size = 1, legend.text.size = 0.7, outer.margins=0, asp=0, scale=.8)
map_neighborhood

```


For the text analysis part, we first drew the barplot of top 20 most frequently used words in the reviews of restaurants of different price levels. The words are almost identical, making the plot useless.


```{r,  warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}
# top 20 frequency

a <- review_td %>% 
     group_by(price, term) %>%
     summarise(sum_num = sum(count)) %>%
     top_n(n = 20, wt = sum_num) %>%
     mutate(key = 1:20)  %>%
     arrange(price,desc(sum_num))  %>%
     ungroup()  %>%
     mutate(idx_label = 80:1) 

sumcount <- review_td %>% 
    group_by(price) %>%
    summarise(total = sum(count)) 

a$total <- 0
a$total[a$price == "1"] <- sumcount$total[sumcount$price == "1"]
a$total[a$price == "2"] <- sumcount$total[sumcount$price == "2"]
a$total[a$price == "3"] <- sumcount$total[sumcount$price == "3"]
a$total[a$price == "4"] <- sumcount$total[sumcount$price == "4"]
a$normalized <- a$sum_num / a$total


a %>% ggplot() +
    geom_bar(aes(x = idx_label, y = normalized, fill = price), stat = "identity", alpha = 0.8) +
    scale_x_continuous(breaks = a$idx_label,labels = a$term) +
    facet_wrap(~price, scales="free_y") + guides(fill = FALSE) +
    xlab("") + ylab("") + coord_flip() + theme_tufte() + ggtitle("Top 20 Normalized Frequency Words of Reviews")  + theme(plot.title = element_text(face = "bold", color = "black", size = 15, hjust = 0.5))

```


We also tried to explore whether price level is related to the number of reviews or the average word count per review. Sadly, the two plots below show insignificant and meaningless results.


```{r,  warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}
review_na$wordcount <- sapply(gregexpr("\\S+", review_na$review), length)
review_na$ave_wc <- review_na$wordcount / review_na$reviewnum
review_na$price <- as.character(review_na$price)
review_na$ratings <- as.character(review_na$ratings)


# price and average word count per review

avewordcount <- ggplot(data = review_na, aes(x = price, y = ave_wc, fill = price))

avewordcount <- avewordcount + geom_boxplot(alpha = 0.8) + theme_minimal() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "transparent")) +
  guides(fill = FALSE) +
  xlab("price") + ylab("average word count per review") + ggtitle("")  + theme(plot.title = element_text(
    face = "bold", color = "black", size = 15, hjust = 0.5)) + theme(strip.background = element_rect(colour = "grey", fill = "grey")) + theme(strip.text.x = element_text(colour = "black", face = "bold", size = 11)) 

avewordcount


# price and number of reviews


review_box <- ggplot(data = review_na, aes(x = price, y = reviewnum, fill = price))

review_box <- review_box + geom_boxplot(alpha = 0.8) + theme_minimal() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "transparent")) +
  guides(fill = FALSE) +
  xlab("price") + ylab("number of reviews") + ggtitle("")  + theme(plot.title = element_text(
    face = "bold", color = "black", size = 15, hjust = 0.5)) + theme(strip.background = element_rect(colour = "grey", fill = "grey")) + theme(strip.text.x = element_text(colour = "black", face = "bold", size = 11)) 

review_box

```


For sentiment score, we intended to see its relationship with price level and rating. We first drew a boxplot, respectively. The relationship between sentiment and ratings is not significant. For price level, we found that boxplot might not the best way to visualize this relationship. Also, we have been plotting many boxplots already. So we changed the to barplot in the above section, showing the relationship of price level and sentiment. 


```{r,  warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}

sentiment$three[review_na$ratings == 3] <- "below or equal three"
sentiment$three[review_na$ratings == 2.5] <- "below or equal three"
sentiment$three[review_na$ratings == 2] <- "below or equal three"
sentiment$three[review_na$ratings == 1.5] <- "below or equal three"
sentiment$three[review_na$ratings == 1] <- "below or equal three"

sentiment$three[review_na$ratings == 3.5] <- "above three"
sentiment$three[review_na$ratings == 4] <- "above three"
sentiment$three[review_na$ratings == 4.5] <- "above three"
sentiment$three[review_na$ratings == 5] <- "above three"


# price and sentiment score

sentiment_price <- ggplot(data = sentiment, aes(x = price, y = sentiment))

sentiment_price <- sentiment_price + geom_boxplot(alpha = 0.8, outlier.colour = NA) + theme_minimal() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "transparent")) +
  guides(fill = FALSE) +
  xlab("Price") + ylab("Sentiment Score") + ggtitle("")  + theme(plot.title = element_text(
    face = "bold", color = "black", size = 15, hjust = 0.5)) + theme(strip.background = element_rect(colour = "grey", fill = "grey")) + theme(strip.text.x = element_text(colour = "black", face = "bold", size = 11)) + geom_point(position = position_jitter(width = 0.4), alpha= 1, size = 1, aes(colour = three)) + scale_color_manual(values = c("dodgerblue", "tomato1"))

sentiment_price



```


```{r,  warning=FALSE, message = FALSE, echo=FALSE, fig.align='center'}

#rating and sentiment score

review_na$ratings <- as.character(review_na$ratings)

sentiment_rating <- ggplot(data = review_na, aes(x = ratings, y = sentiment, fill = ratings))

sentiment_rating <- sentiment_rating + geom_boxplot(alpha = 0.8) + theme_minimal() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "transparent")) +
  guides(fill = FALSE) +
  xlab("Ratings") + ylab("Sentiment Score") + ggtitle("")  + theme(plot.title = element_text(
    face = "bold", color = "black", size = 15, hjust = 0.5)) + theme(strip.background = element_rect(colour = "grey", fill = "grey")) + theme(strip.text.x = element_text(colour = "black", face = "bold", size = 11)) 

sentiment_rating

```


# Implementation

Besides some maps and wordclouds, most of the plots in this project are designed interactively. For statistically plots like bar chart and boxplot, interactive visualization provides more detailed information, which would help viewers to get a clearer idea of the relationships we were studying. For maps, interactive visualization can make viewers choose what kind of information they want to see: local or general distribution of restaurants? overall crime rates or certain type of crime in restaurant's neighborhood? etc.

# Evaluation 
  
Conclusion 1. Luxurious(four-dollar-sign) restaurants have better services than other restaurants in general. They provide consumers with better parking services, easier access to public transportation and quieter environments. The distribution of restaurants in Pittsburgh is generally affected by the function and location of the neighborhoods. For example, the central neighborhoods and neighborhoods along riverside attract more restaurants compared to others. In addition, food in the most expensive restaurants consists of expensive ingredients like salmon and whiskey. 
  
Conclusion 2. Text analysis shows that most reviews on yelp are more associated with the food. However, luxurious restaurants have the smallest proportion of positive reviews compared to other cheaper restaurants. Therefore, consumers are least satisfied about food provided by luxurious restaurants among all 4 price-level restaurants. This could be due to either an average taste of the food, or a higher expectation of the taste according to its high price. 

Conclusion 3. Since luxurious restaurants have higher median of ratings from consumers, we can infer that consumers rate them higher not purely due to good food, but partly for services as well. It is possible that they expect more delicious food in luxurious restaurants, but only get average food, which result that they wrote down more neutral reviews about most expensive restaurants. Therefore, our hypothesis is proved, that more expensive restaurants do not necessarily provide more satisfying food.


# Next Steps

We visualized the Yelp data mainly through boxplot and bar chart. This is due to the fact that nearly all (useful) variables in the dataset are categorical, instead of numeric. With more time allowed, we might be able to think of some more creative ways of presenting these categorical data. Nevertheless, the boxplots and bar charts in our project can effectively and accurately demonstrate the data as well. 

Another limitation of data is that only four US cities are available in the Yelp dataset. The result would be more significant and interesting if there are more cities are available to us in the dataset, especially large cities like New York and Los Angeles.  



# Group Members and Work Distribution

Yushu Zhou (yz3045): data cleaning + statistical graphs + shiny + description 

Chuyue Zhang (cz2433): maps + spatial analysis + description

Kehui Wang (kw2441): review cleaning + text analysis + description

Cinthia Liu (cl3518): description




